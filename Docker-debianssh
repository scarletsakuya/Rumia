FROM library/debian:latest

ENV ROOT_PASSWORD=root \
    HTTP_USER=sakuya \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    LC_ALL=en_US.UTF-8 \
    TZ=Asia/Shanghai

RUN set -ex \
    && apt-get update \
    && apt-get install -y openssh-server locales tzdata curl bash \
    squid3 nghttp2 apache2-utils \
    && locale-gen ${LC_ALL} \
    && localedef -i en_US -f UTF-8 en_US.UTF-8 \
    && ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone \
    && echo "${TZ}" > /etc/timezone \
    && dpkg-reconfigure -f noninteractive tzdata \
    # ssh set 
    && sed -ri "s/UsePrivilegeSeparation.*/UsePrivilegeSeparation no/g" /etc/ssh/sshd_config \
    && sed -ri 's/PermitRootLogin without-password/PermitRootLogin yes/' /etc/ssh/sshd_config \
    && sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd
    && echo root:${ROOT_PASSWORD}|chpasswd \
    && htpasswd -b -c /etc/squid/password ${HTTP_USER} ${ROOT_PASSWORD} \
    && curl -L -o /tmp/go.sh https://install.direct/go.sh \
    && chmod +x /tmp/go.sh \
    && /tmp/go.sh \
    && apt-get clean \
    && apt-get autoclean \
    && apt-get autoremove \
    && rm -rf /tmp/* /root/.cache /var/lib/apt/lists/*

#COPY config file
COPY nghttpx.conf /etc/nghttpx/nghttpx.conf
COPY squid.conf /etc/squid/squid.conf
COPY blueset.telegram-config.yaml /root/.ehforwarderbot/profiles/default/bluestet.telegram/config.yaml
COPY default-config.yaml /root/.ehforwarderbot/profiles/default/config.yaml
COPY v2rayconfig.json /etc/v2ray/config.json
COPY entrypoint.sh /usr/local/bin/

#vmess
ENV VMESS_PORT=5061 \
    VMESS_ID=00000000-0000-0000-0000-000000000000 \
    VMESS_LEVEL=1 \
    VMESS_ALTERID=64

#kcp
ENV KCP_PORT_VMESS=5061 \
    KCP_MUT=1350 \
    KCP_TTI=50 \
    KCP_UPLINK=5 \
    KCP_DOWNLINK=20 \
    KCP_READBUFF=2 \
    KCP_WRITEBUFF=2

EXPOSE 20443/tcp 20443/udp 22/tcp ${VMESS_PORT}/tcp ${KCP_PORT_VMESS}/udp

ENTRYPOINT [ "bash", "/usr/local/bin/entrypoint.sh" ]
